<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitFriend</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="../static/css/stylesheet.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/bulma@0.9.2/js/bulma.min.js">

    </script>

    <style>
        main {
            width: 1100px;
            margin: auto;
            padding: 20px;

        }

        table,
        th,
        tr {
            border: 3px solid cornflowerblue;
            border-collapse: collapse;
            color: white !important;
        }

        tr {
            text-align: center;
        }

        th {
            text-align: center;
            min-width: 157px;
            max-width: 157px;
        }

        .tile_title {
            font-size: 30px;
        }

        .content {
            font-size: 20px;
            margin-bottom: 0px !important;
        }

        .input {
            width: 100px;
        }

        textarea {
            min-width: 200px !important;
            max-width: 200px !important;
        }

        .tile.is-parent.is-vertical {
            padding: 0px !important;
        }

        .slot {
            height: 600px;
        }

        .container {
            width: 500px;
            clear: both;
            padding: 10px;
            border-color: white;
            align-content: right;
        }

        .label {
            color: white !important;
            /* float:left; */
            height: auto;
            font-size: 16px;
            line-height: center;
            width: 200px;
            align-content: center !important;
            /* clear: both; */
            margin: auto;

        }

        body {
            background-color: #303030;
        }

        section {
            width: 500px;
            height: 600px;
            border-color: white;
        }

        #createSession {
            color: #6ae9a5;
            font-weight: bold;
            font-size: 30px;
            text-align: center;
            margin-bottom: 15px;
        }

        .tile {
            min-width: 155px;
            max-width: 155px;
            position: relative;
        } 

        .invisible {
            top: 0;
            left: 0;
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;

        } 

        select {
           width: 200px; 
        }
        input {
            width: 200px !important;
        }

        #submit {
            margin: auto;
            margin-top: 30px;

            width: 200px;
        }

        .fill_up {
            width: 300px;
            margin: auto;
            padding: 20px;
            border: 2px solid #6ae9a5;
        }

        .hidden_value {
            display: none;
        }


    </style>

</head>

<body>
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <script>
                alert("{{messages[0] }}");
            </script>
        {% endif %}
    {% endwith %}
    <header>
        <div class="logout">
            <a href="/logout">üì§</a>
        </div>
        <div class="guide-box">
            <a href="{{ url_for('guide')}}" id="userGuide">ÏÇ¨Ïö© Í∞ÄÏù¥Îìú</a>
        </div>

        <div class="title">
            FitFriend
        </div>
    </header>

    <main>
        <div id="week_calendar">
            <table>
                <tr>
                    <th>Mon</th>
                    <th>Tue</th>
                    <th>Wed</th>
                    <th>Thu</th>
                    <th>Fri</th>
                    <th>Sat</th>
                    <th>Sun</th>
                </tr>
                <tr>

{#        Ï°∞Ìöå           #}
        {% set days = ['MON', 'TUES', 'WED', 'THURS' , 'FRI', 'SAT', 'SUN'] %}

        {% for day in days %}

            <th class="slot" id={{ day }} >
                            <div class="tile is-parent is-vertical">
                                {% for item in sessionDataList %}
                                    {% if item.day == day %}

                                        {#  participates Î¨∏ÏûêÏó¥ ÎßåÎì§Í∏∞  #}
                                        {% set participates = '' %}
                                        {% for participant in item.participants %}
                                            {% set participates = participates + participant.name + ' ' %}
                                        {% endfor %}

                                        <article class="tile is-child notification is-primary article" style="cursor:pointer;">
                                            <!-- Your tile content here -->
                                            <p class="content">{{item.userName}}</p>
                                            <p class="content">{{ item.time }}Ïãú {{ item.field}} </p>
                                            <p class="content"><span>{{ item.participants|count}}</span>Î™Ö / <span>{{ item.max_member }}</span>Î™Ö </p>
                                            <input type="hidden" value="{{ item._id }}">
                                            <div class="hover_box" style="border: 1px solid azure">
                                                <span class="middle_title">Ï∞∏Ïó¨Ïûê Î™ÖÎã®</span>
                                                {% for participant in item.participants %}
                                                    <div>{{ participant.name }}</div>
                                                {% endfor %}
                                            </div>
                                        </article>
                                    {% endif %}
                                {% endfor %}
                            </div>
        </th>
        {% endfor %}

{#        <th class="slot" id="Ìôî"></th>#}
{#        <th class="slot" id="Ïàò"></th>#}
{#        <th class="slot" id="Î™©"></th>#}
{#        <th class="slot" id="Í∏à"></th>#}
{#        <th class="slot" id="ÌÜ†"></th>#}
{#        <th class="slot" id="Ïùº"></th>#}
        </tr>
        </table>
        </div>
        <br>
        <section class="fill_up">
            <h2 class="header" id="createSession">Ïö¥Îèô ÏÑ∏ÏÖò ÏÉùÏÑ±</h2>
            <form id="to-be-form" method="post" action="/session">
                <div class="label">ÏöîÏùº<br>
                    <div class="select is-primary">
                        <select name="day" id="post-day" placeholder="ÏöîÏùºÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî">
                            <optgroup label="ÏöîÏùºÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî">
                                <option value="MON">Ïõî</option>
                                <option value="TUES">Ìôî</option>
                                <option value="WED">Ïàò</option>
                                <option value="THURS">Î™©</option>
                                <option value="FRI">Í∏à</option>
                                <option value="SAT">ÌÜ†</option>
                                <option value="SUN">Ïùº</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
                <div class="label">
                    ÏãúÍ∞Ñ <br>
                    <div class="select is-primary">
                        <select id="post-time" placeholder="ÏãúÍ∞ÑÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî" name="time">
                            <!-- optgroup Ï§ÑÏùº Ïàò ÏûàÎÇò ÌôïÏù∏ -->
                            <optgroup>
                                <option value="1">01:00</option>
                                <option value="2">02:00</option>
                                <option value="3">03:00</option>
                                <option value="4">04:00</option>
                                <option value="5">05:00</option>
                                <option value="6">06:00</option>
                                <option value="7">07:00</option>
                                <option value="8">08:00</option>
                                <option value="9">09:00</option>
                                <option value="10">10:00</option>
                                <option value="11">11:00</option>
                                <option value="12">12:00</option>
                                <option value="13">13:00</option>
                                <option value="14">14:00</option>
                                <option value="15">15:00</option>
                                <option value="16">16:00</option>
                                <option value="17">17:00</option>
                                <option value="18">18:00</option>
                                <option value="19">19:00</option>
                                <option value="20">20:00</option>
                                <option value="21">21:00</option>
                                <option value="22">22:00</option>
                                <option value="23">23:00</option>
                                <option value="24">24:00</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
                <div class="label">
                    Ïö¥Îèô Ï¢ÖÎ™© <br>
                    <div class="select is-primary">
                        <select name="field" id="post-field" placeholder="Ï¢ÖÎ™©ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî">
                            <optgroup label="Ï¢ÖÎ™©ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî">
                                <option value="fitness">Ìó¨Ïä§</option>
                                <option value="running">Îü∞Îãù</option>
                                <option value="swimming">ÏàòÏòÅ</option>
                                <option value="basketball">ÎÜçÍµ¨</option>
                            </optgroup>
                        </select>
                    </div>

                </div>
                </div>
                <div class="label">
                    ÏµúÎåÄ Ïù∏Ïõê <br><input type="text" id="post-max_member" class="input is-primary" placeholder="ÏµúÎåÄ Î™®Ïßë Ïù∏Ïõê"
                        name="max_member">
                    <div id="textarea" class="label"> ÎπÑÍ≥† <br> <textarea id="post-note" cols="20" rows="2"
                            class="textarea is-primary" name="note"></textarea>
                    </div>
                    <div><input name="userName" class="hidden_value" value="{{ username }}" /></div>
                    <div><input name="userId" class="hidden_value" value="{{ userId }}" /></div>
                    <div><input name="date" class="hidden_value" id='dateInput' /></div>
                    <div class="label">
                        <label for="submit" class="label"> </label>
                        <button type="submit" id="submit" class="button is-primary">ÏÑ∏ÏÖò
                            ÏÉùÏÑ±</button>
                    </div>
            </form>
        </section>


        <div class="modal">
            <div class="modal-background"></div>
            <div class="modal-content">
                <!-- Any other Bulma elements you want -->
                <div class="card">
                    <div class="card-content">
                        <div class="content">
                            <h3 id="modal_title"></h3>
                            <button id="modal_cancel" class="button is-primary is-light">Ï∑®ÏÜå</button>
                            <button id="modal_ok"  class="button is-primary is-light is-hidden" onclick='clickOkBtn("ok1")'>ÌôïÏù∏</button>
                            <button id="modal_ok2" class="button is-primary is-light is-hidden" onclick='clickOkBtn("ok2")'>ÌôïÏù∏</button>
                            <button id="modal_ok3" class="button is-primary is-light is-hidden" onclick='clickOkBtn("ok3")'>ÌôïÏù∏</button>

                        </div>
                    </div>
                </div>

            </div>
            <button id="close" class="modal-close is-large" aria-label="close"></button>
        </div>

    </main>


<script>
    let articles = document.querySelectorAll('.article');
    for(let i = 0; i < articles.length; i++){
        articles[i].addEventListener('click', (e) => {
            document.querySelector('.modal').classList.add('is-active');
            clickSession(e);
        })
    }

    let close = document.querySelector('#close');
    let modal_cancel = document.querySelector('#modal_cancel');

    close.addEventListener('click', () => {
        document.querySelector('.modal').classList.remove('is-active');
    })

    modal_cancel.addEventListener('click', () => {
        document.querySelector('.modal').classList.remove('is-active');
    })



    let modal_title = document.querySelector('#modal_title');
    let modal_ok = document.querySelector('#modal_ok');

    let loginUserName = '{{ username }}';
    let loginUserId = '{{ userId }}';
    let selectedSessionId;


    function clickOkBtn(param){
        if(param === 'ok1'){
            // Ï∞∏Ïó¨
            participate_session(loginUserName, loginUserId, selectedSessionId);

        } else if(param === 'ok2'){
            // Ï∞∏Ïó¨Ï∑®ÏÜå
            except_session(loginUserName, loginUserId, selectedSessionId);

        } else if(param === 'ok3'){
            // ÏÇ≠Ï†ú
            delete_session(selectedSessionId);

        }
    }

    function clickSession(e){
        // Î™®Îã¨ ÏÉùÍ∏∏ Îïå Î∂ÑÍ∏∞Ï≤òÎ¶¨ ÌïòÍ∏∞

        let createUserName;
        let currentNum;
        let maxNum;

        let selectedParticipates  = [];


        createUserName = e.currentTarget.children[0].innerText;
        currentNum = e.currentTarget.children[2].children[0].innerText;
        maxNum = e.currentTarget.children[2].children[1].innerText;
        selectedSessionId = e.currentTarget.children[3].value;
        console.log(selectedSessionId);

        let participationNumber = e.currentTarget.children[4].children.length;

        for(let i = 1; i < e.currentTarget.children[4].children.length; i++){
            selectedParticipates.push(e.currentTarget.children[4].children[i].innerText);
        }

        // #1 Ï∞∏Ïó¨Ïù∏Ïõê Î¶¨Ïä§Ìä∏Ïóê Î°úÍ∑∏Ïù∏ Ïú†Ï†ÄÍ∞Ä ÏóÜÍ≥† ÏûêÎ¶¨Í∞Ä ÎÇ®ÏïÑ ÏûàÏùÑ Îïå => Ï∞∏Ïó¨ Î™®Îã¨
        if(selectedParticipates.indexOf(loginUserName) && maxNum > currentNum){
            console.log('Ï∞∏Ïó¨ Î™®Îã¨ ÏßÑÏûÖ');
            modal_title.innerText = 'Ï∞∏Ïó¨ÌïòÍ≤†ÏäµÎãàÍπå?';
                document.getElementById('modal_ok').classList.remove('is-hidden');
                document.getElementById('modal_ok2').classList.add('is-hidden');
                document.getElementById('modal_ok3').classList.add('is-hidden');
                {#participate_session(loginUserName, loginUserId, selectedSessionId);#}
        }

        // #2 Ï∞∏Ïó¨Ïù∏Ïõê Î¶¨Ïä§Ìä∏Ïóê Î°úÍ∑∏Ïù∏ Ïú†Ï†ÄÍ∞Ä ÏóÜÍ≥† ÏûêÎ¶¨Í∞Ä ÏóÜÏùÑ Îïå => Î∂àÍ∞Ä
        if(selectedParticipates.indexOf(loginUserName) === -1 && maxNum <= currentNum){
            modal_title.innerText = 'Î™®Îëê ÎßàÍ∞ê ÎêòÏóàÏäµÎãàÎã§.';
            document.getElementById('modal_ok').classList.add('is-hidden');
            document.getElementById('modal_ok2').classList.add('is-hidden');
            document.getElementById('modal_ok3').classList.add('is-hidden');
            modal_ok.addEventListener('click', () => {
                alert('Î™®Îëê ÎßàÍ∞ê ÎêòÏóàÏäµÎãàÎã§.');
            })
        }

        // #3 Ï∞∏Ïó¨Ïù∏Ïõê Î¶¨Ïä§Ìä∏Ïóê Î°úÍ∑∏Ïù∏ Ïú†Ï†ÄÍ∞Ä ÏûàÎäî Í≤ΩÏö∞[0Î≤à Ïß∏ ÏÉùÏÑ±Ïûê] => ÏÇ≠Ï†ú Î™®Îã¨
        if(selectedParticipates.indexOf(loginUserName) === 0){
            modal_title.innerText = 'Ïö¥Îèô ÏÑ∏ÏÖòÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?';
            console.log('ÏÇ≠Ï†ú Î™®Îã¨ ÏßÑÏûÖ');
            document.getElementById('modal_ok').classList.add('is-hidden');
            document.getElementById('modal_ok2').classList.add('is-hidden');
            document.getElementById('modal_ok3').classList.remove('is-hidden');

            modal_ok.addEventListener('click', () => {
                console.log('ÏÇ≠Ï†ú Î™®Îã¨ Ïã§Ìñâ');
                {#delete_session(selectedSessionId);#}
            })
        }

        // #4 Ï∞∏Ïó¨Ïù∏Ïõê Î¶¨Ïä§Ìä∏Ïóê Î°úÍ∑∏Ïù∏ Ïú†Ï†ÄÍ∞Ä ÏûàÎäî Í≤ΩÏö∞ => Ï∞∏Ïó¨ Ï∑®ÏÜå Î™®Îã¨
        if(selectedParticipates.indexOf(loginUserName) >= 1){
            modal_title.innerText = 'Ïö¥Îèô ÏÑ∏ÏÖòÏùÑ Ï∑®ÏÜåÌïòÏãúÍ≤†ÏäµÎãàÍπå?';
            console.log('Ï∑®ÏÜå Î™®Îã¨ ÏßÑÏûÖ');
            document.getElementById('modal_ok').classList.add('is-hidden');
            document.getElementById('modal_ok2').classList.remove('is-hidden');
            document.getElementById('modal_ok3').classList.add('is-hidden');

            modal_ok.addEventListener('click', () => {
                console.log('Ï∑®ÏÜå Î™®Îã¨ ÏßÑÌñâ');

                {#except_session(loginUserName, loginUserId, selectedSessionId);#}
            })
        }






    }



        function participate_session(username, userid, sessionId) {



        $.ajax({
            type: 'POST',
            url: '/session/participate',
            data: { "userName": username, "userId": userid, "sessionId": sessionId },
            async : false,
            success: function (response) {
                if (response['result'] == 'success') {
                    alert("Ï∞∏Ïó¨ÎêòÏóàÏäµÎãàÎã§!");
                    window.location.reload();

                }
                if (response['result'] == 'fail') {
                    alert(response["msg"]);
                }
            }
        });
    }

        function except_session(username, userid, sessionId) {


        $.ajax({
            type: 'POST',
            url: '/session/quit',
            async : false,
            data: { "userName": username, "userId": userid, "sessionId": sessionId },
            success: function (response) {
                if (response['result'] == 'success') {
                    alert("Ï∞∏Ïó¨ Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§!");
                    window.location.reload()

                } else {
                    alert("ÏóÖÎç∞Ïù¥Ìä∏ Ïã§Ìå®");
                }
            }
        });
    }

        function delete_session(sessionId) {
        $.ajax({
            type: 'PUT',
            url: '/session/' + sessionId,
            data: {},
            async : false,
            success: function (response) {
                if (response['result'] == 'success') {
                    alert("ÏÑ∏ÏÖò ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§!");
                    window.location.reload();

                }
            }
        });
    }

        // function call_sessionId(userId) {
    //     $.ajax({
    //         type: 'POST',
    //         url: '/session/retrive'
    //         data: { "userId": userId },
    //         success: function (response) {
    //             if (response['result'] == 'success') {
    //                 alert("ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏÑ∏ÏÖò Ï†ïÎ≥¥ ÌôïÏù∏ ÏôÑÎ£å")
    //                 if (ÌòÑÏû¨ Ïù∏Ïõê == ÏµúÎåÄ Ïù∏Ïõê ) {
    //         Î∂àÍ∞Ä
    //     } else
    //     if (Î°úÍ∑∏Ïù∏ID == ÏÉùÏÑ±ÏûêID) {
    //         ÏÇ≠Ï†ú
    //                     else
    //         Ï∑®ÏÜå

    //     }
    // }
    //         }
    //     })
    // }
    $(document).ready(function () {


        const date = new Date();
        const year = date.getFullYear();
        const month = ('0' + (date.getMonth() + 1)).slice(-2);
        const day = ('0' + (date.getDate())).slice(-2);
        const today = `${year}${month}${day}`;

        $("#dateInput").val(today);
        console.log(today)
    });




</script>
</body>


</html>