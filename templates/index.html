<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitFriend</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link rel="stylesheet" href="../static/css/stylesheet.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/bulma@0.9.2/js/bulma.min.js"> </script>

    <style>
        main {
            width: 1100px;
            margin: auto;
            padding: 20px;

        }

        table,
        th,
        tr {
            border: 3px solid cornflowerblue;
            border-collapse: collapse;
            color: white !important;
        }

        tr {
            text-align: center;
        }

        th {
            text-align: center;
            min-width: 157px;
            max-width: 157px;
        }

        .tile_title {
            font-size: 30px;
        }

        .content {
            font-size: 20px;
            margin-bottom: 0px !important;
        }

        .input {
            width: 100px;
        }

        textarea {
            min-width: 200px !important;
            max-width: 200px !important;
        }

        .tile.is-parent.is-vertical {
            padding: 0px !important;
        }

        .slot {
            height: 600px;
        }

        .container {
            width: 500px;
            clear: both;
            padding: 10px;
            border-color: white;
            align-content: right ;
        }

        .label {
            color: white !important;
            /* float:left; */
            height: auto;
            font-size: 16px;
            line-height: center;
            width: 200px;
            align-content: center !important;
            /* clear: both; */
            margin: auto;

        }

        body {
            background-color: #303030;
        }

        section {
            width: 500px;
            height: 600px;
            border-color: white;
        }

        #createSession {
            color: #6ae9a5;
            font-weight: bold;
            font-size: 30px;
            text-align: center;
            margin-bottom: 15px;
        }

        .tile {
            min-width: 155px;
            max-width: 155px;
            position: relative;
        } 

        /* .notification {
            position: relative;
            min-width: 155px;
            max-width: 155px;
        } */

        .invisible {
            top: 0;
            left: 0;
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;

        } 

        select {
           width: 200px; 
        }
        input {
            width: 200px !important;
        }

        #submit {
            margin: auto;
            margin-top: 30px;

            width: 200px;
        }

        .fill_up {
            width: 300px;
            margin: auto;
            padding: 20px;
            border: 2px solid #6ae9a5;
        }

        /* #textarea {
            display: flex;
            
        } */

        /* #to-be-form { 
            border: 2px solid #6ae9a5; 
        } */

    </style>
    <script>

        //  로딩 후 바로 현재 있는 운동세션들 모두 보여줌 
        // window.onload = add_tile; //, login_info;

        // //로그인 정보 받아와야 함 (이후 session함수를 사용하기 위해 필요)
        // // function login_info() {
        // //     type: "GET",
        // // username 
        // // userId
        // // }

        // // GET을 할 수 있는 URL 생성 필요? 

     

        // function add_tile() {
        //     $(document).ready(function () {
        //         if ("{{session['name']}}" != "");
        //         alert("{{session['gender']}}");
        //     })

        //     // $('#월').empty()
        //     // $('#화').empty()
        //     // $('#수').empty()
        //     // $('#목').empty()
        //     // $('#금').empty()
        //     // $('#토').empty()
        //     // $('#일').empty()

        //     // // $.ajax({
        //     //     type: "GET",
        //     //     url: "/tile",
        //     //     data: {},
        //     //     success: function (response) {
        //     //         let session_info = response["data"];
        //     //         console.log(session_info);
        //     //         for (let i = 0; i < session_info.length; i++) {
        //     //             let number = i
        //     //             let slot = (session_info[i]["day"]);
        //     //             make_tile(number, slot);
        //     //         }
        //     //     }
        //     // }
        //     // )

        // }

        // // // DB안 데이터로 타일을 생성
        // // function make_tile(number, day) {
        // //     let tempHtml =
        // //         // `<div class="tile">
        // //         //     <article class="tile is-child notification is-primary">
        // //         //         <p class="tile_title">${session_info[i]["name"]}</p>
        // //         //         <p class="tile_title">${session_info[i]["gender"]}</p>
        // //         //         <p class="content">${session_info[i]["field"]}</p>
        // //         //         <p class="content">1/${session_info[i]["max_member"]}</p>
        // //         //     </article>
        // //         // </div>`

        // //         // `<div class="tile">
        // //         //     <div class="tile is-parent is-vertical">
        // //         //         <article class="tile is-child notification is-primary">
        // //         //             <p class="tile_title">남재희</p>
        // //         //             <p class="tile_title">남</p>
        // //         //             <p class="content">1시 런닝</p>
        // //         //             <p class="content">(1/4)</p>
        // //         //         </article>
        // //         //     </div>
        // //         // </div>`


        // //         //     어떻게 해야 제대로 된 위치에 갈 지 확인
        // //         // $("#" + day).append(tempHtml);


        // // }

        // function create_session() {
        //     // let userName = username;
        //     // let userId = userId;
        //     let day = $("#post-day").val();
        //     let time = $("#post-time").val();
        //     let field = $("#post-field").val();
        //     let max_member = $("#post-max_member").val();
        //     // let note = $("#post-note").val(); //session.py에서 노트 추가될때까지 대기 - 현재 상태에서 활성화 시킬 시 404
        //     let result;

        //     //계속 실패가 뜸 - 터미널에선 201
        //     $.ajax({
        //         type: "POST",
        //         url: "/session",
        //         data: { day: day, time: time, field: field, max_member: max_member }, //note : note 는 session.py에서 노트 추가될때까지 대기
        //         //username과 userId정보도 보내도록 해야함
        //         uccess: function (response) {
        //             if (response["result"] == "success") {
        //                 alert("성공");

        //                 result = response["data"];
        //                 add_tile();
        //             } else {
        //                 alert("실패");
        //             }
        //         }
        //     })
        // }

        // // // 타일 추가시키는 더미함수 - 작동됨
        // // // function make_dummy() {
        // // //     let tempHtml =
        // // //         `<div class="tile">
        // // //             <div class="tile is-parent is-vertical">
        // // //                 <article class="tile is-child notification is-primary">
        // // //                     <p class="tile_title">남재희</p>
        // // //                     <p class="tile_title">남</p>
        // // //                     <p class="content">1시 런닝</p>
        // // //                     <p class="content">(1/4)</p>
        // // //                 </article>
        // // //             </div>
        // // //         </div>`

        // // //     $('#화').append(tempHtml);
        // // // }

        // // //     function updateOnSunday() {
        // // //     // 현재 날짜와 시간 가져오기
        // // //     const currentDate = new Date();
        // // //     const currentDay = currentDate.getDay(); // 0은 일요일, 1은 월요일, ...

        // // //     // 업데이트를 원하는 시간 (24시간 형식)
        // // //     const updateHour = 24; // 예시로 24시간으로 설정

        // // //     // 일요일이고 현재 시간이 업데이트 시간보다 이후인 경우에만 업데이트 수행
        // // //     if (currentDay === 0 && currentDate.getHours() >= updateHour) {
        // // //         // 여기에 실제로 수행할 업데이트 로직 추가
        // // //         console.log('Update logic executed on Sunday at', currentDate);
        // // //     }
        // // // }

        // // // // 매 분마다 updateOnSunday 함수를 호출하는 setInterval
        // // // setInterval(updateOnSunday, 3600000); // 3600000밀리초(60분) 간격으로 실행
    </script>
</head>

<body>
    <header>
        <div class="guide-box">
            <a href="./guide.html" id="userGuide">사용 가이드</a>
        </div>

        <div class="title">
            FitFriend
        </div>
    </header>

    <main>
        <div id="week_calendar">
            <table>
                <tr>
                    <th>Mon</th>
                    <th>Tue</th>
                    <th>Wed</th>
                    <th>Thu</th>
                    <th>Fri</th>
                    <th>Sat</th>
                    <th>Sun</th>
                </tr>
                <tr>

{#        조회           #}
        {% set days = ['MON', 'TUE', 'WED', 'THURS' , 'FRI', 'SAT', 'SUN'] %}

        {% for day in days %}

            <th class="slot" id={{ day }} >
                            <div class="tile is-parent is-vertical">
                                {% for item in sessionDataList %}
                                    {% if item.day == day %}

                                        {#  participates 문자열 만들기  #}
                                        {% set participates = '' %}
                                        {% for participant in item.participants %}
                                            {% set participates = participates + participant.name + ' ' %}
                                        {% endfor %}

                                        <article class="tile is-child notification is-primary article" style="cursor:pointer;">
                                            <!-- Your tile content here -->
                                            <p class="content">{{item.userName}}</p>
                                            <p class="content">{{ item.time }}시 {{ item.field}} </p>
                                            <p class="content"><span>{{ item.participants|count}}</span>명 / <span>{{ item.max_member }}</span>명 </p>
                                            <input type="text" value="{{ item._id }}">
                                            <div class="hover_box" style="border: 1px solid azure">
                                                <span class="middle_title">참여자 명단</span>
                                                {% for participant in item.participants %}
                                                    <div>{{ participant.name }}</div>
                                                {% endfor %}
                                            </div>
                                        </article>
                                    {% endif %}
                                {% endfor %}
                            </div>
        </th>
        {% endfor %}

{#        <th class="slot" id="화"></th>#}
{#        <th class="slot" id="수"></th>#}
{#        <th class="slot" id="목"></th>#}
{#        <th class="slot" id="금"></th>#}
{#        <th class="slot" id="토"></th>#}
{#        <th class="slot" id="일"></th>#}
        </tr>
        </table>
        </div>
        <br>
        <section class="fill_up">
            <h2 class="header" id="createSession">운동 세션 생성</h2>
            <div id="to-be-form">
                <div class="label">요일<br>
                    <div class="select is-primary">
                        <select name="day" id="post-day">
                            <optgroup label="요일을 선택하세요">
                                <option value="mon">월</option>
                                <option value="tue">화</option>
                                <option value="wed">수</option>
                                <option value="thu">목</option>
                                <option value="fri">금</option>
                                <option value="sat">토</option>
                                <option value="sun">일</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
                <div class="label">
                    시간 <br><div class="select is-primary">
                        <select id="post-time">
                            <!-- optgroup 줄일 수 있나 확인 -->
                            <optgroup>
                                <option value="1">01:00</option>
                                <option value="2">02:00</option>
                                <option value="3">03:00</option>
                                <option value="4">04:00</option>
                                <option value="5">05:00</option>
                                <option value="6">06:00</option>
                                <option value="7">07:00</option>
                                <option value="8">08:00</option>
                                <option value="9">09:00</option>
                                <option value="10">10:00</option>
                                <option value="11">11:00</option>
                                <option value="12">12:00</option>
                                <option value="13">13:00</option>
                                <option value="14">14:00</option>
                                <option value="15">15:00</option>
                                <option value="16">16:00</option>
                                <option value="17">17:00</option>
                                <option value="18">18:00</option>
                                <option value="19">19:00</option>
                                <option value="20">20:00</option>
                                <option value="21">21:00</option>
                                <option value="22">22:00</option>
                                <option value="23">23:00</option>
                                <option value="24">24:00</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
                <div class="label">
                    운동 종목 <br><div class="select is-primary">
                        <select name="field" id="post-field">
                            <optgroup label="종목을 선택하세요">
                                <option value="fitness">헬스</option>
                                <option value="running">런닝</option>
                                <option value="swimming">수영</option>
                                <option value="basketball">농구</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
                <div  class="label">
                    최대 인원 <br><input type="text" id="post-max_member" class="input is-primary">
                </div>
                <div id="textarea" class="label"> 비고 <br> <textarea id="post-note" cols="20" rows="2" class="textarea is-primary"></textarea>
                </div>
                <div class="label">
                    <label for="submit" class="label"> </label>
                    <button type="button" id="submit" class="button is-primary" onclick="create_session();">세션 생성</button>
                </div>
            </div>
        </section>

        <div style="color: white">
            {{ sessionDataList[0].userName }}
        </div>


        <div class="modal">
            <div class="modal-background"></div>
            <div class="modal-content">
                <!-- Any other Bulma elements you want -->
                <div class="card">
                    <div class="card-content">
                        <div class="content">
                            <h3 id="modal_title"></h3>
                            <button id="modal_cancel" class="button is-primary is-light">취소</button>
                            <button id="modal_ok" class="button is-primary is-light">확인</button>
                        </div>
                    </div>
                </div>

            </div>
            <button id="close" class="modal-close is-large" aria-label="close"></button>
        </div>

    </main>

</body>

<script>

    let articles = document.querySelectorAll('.article');
    for(let i = 0; i < articles.length; i++){
        articles[i].addEventListener('click', (e) => {
            document.querySelector('.modal').classList.add('is-active');
            clickSession(e);
        })
    }

    let close = document.querySelector('#close');
    let modal_cancel = document.querySelector('#modal_cancel');

    close.addEventListener('click', () => {
        document.querySelector('.modal').classList.remove('is-active');
    })

    modal_cancel.addEventListener('click', () => {
        document.querySelector('.modal').classList.remove('is-active');
    })



    let modal_title = document.querySelector('#modal_title');
    let modal_ok = document.querySelector('#modal_ok');

    function clickSession(e){
        // 모달 생길 때 분기처리 하기
        let loginUserName = '{{ username }}';
        let createUserName;
        let currentNum;
        let maxNum;
        let selectedSessionId;
        let selectedParticipates  = [];

        createUserName = e.target.children[0].innerText;
        currentNum = e.target.children[2].children[0].innerText;
        maxNum = e.target.children[2].children[1].innerText;
        selectedSessionId = e.target.children[3].value;

        let participationNumber = e.target.children[4].children.length;

        for(let i = 1; i < e.target.children[4].children.length; i++){
            selectedParticipates.push(e.target.children[4].children[i].innerText);
        }

        // #1 참여인원 리스트에 로그인 유저가 없고 자리가 남아 있을 때 => 참여 모달
        if(selectedParticipates.indexOf(loginUserName) && maxNum > currentNum){
            modal_title.innerText = '참여하겠습니까?';
            modal_ok.addEventListener('click', () => {
                alert('참여모달 실행');
            })
        }

        // #2 참여인원 리스트에 로그인 유저가 없고 자리가 없을 때 => 불가
        if(selectedParticipates.indexOf(loginUserName) === -1 && maxNum <= currentNum){
            modal_title.innerText = '모두 마감 되었습니다.';
            modal_ok.addEventListener('click', () => {
                alert('모두 마감 되었습니다.');
            })
        }

        // #3 참여인원 리스트에 로그인 유저가 있는 경우[0번 째 생성자] => 삭제 모달
        if(selectedParticipates.indexOf(loginUserName) === 0){
            modal_title.innerText = '운동 세션을 삭제하시겠습니까?';
            modal_ok.addEventListener('click', () => {
                alert('삭제모달 실행');
            })
        }

        // #4 참여인원 리스트에 로그인 유저가 있는 경우 => 참여 취소 모달
        if(selectedParticipates.indexOf(loginUserName) >= 1){
            modal_title.innerText = '운동 세션을 취소하시겠습니까?';
            modal_ok.addEventListener('click', () => {
                alert('취소모달 실행');

            })
        }




    }





</script>


</html>